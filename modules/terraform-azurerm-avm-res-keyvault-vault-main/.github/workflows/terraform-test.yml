---
name: terraform test

on:
  pull_request:
    types: ["opened", "reopened", "synchronize"]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  testexamples:
    if: github.event.repository.name != 'terraform-azurerm-avm-template'
    runs-on: [self-hosted, windows]
    environment: test
    env:
      TF_IN_AUTOMATION: 1
      TF_VAR_enable_telemetry: false
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 #v4.1.7

      - name: Test example
        shell: pwsh
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
          VARS_CONTEXT: ${{ toJson(vars) }}
        run: |
          $ErrorActionPreference = "Stop"
          $MAX_RETRIES = 10
          $RETRY_COUNT = 0

          # Azure Login with retries
          while ($RETRY_COUNT -lt $MAX_RETRIES) {
            try {
              az login --identity --username $env:MSI_ID > $null
              break
            } catch {
              $RETRY_COUNT++
              Start-Sleep -Seconds 10
            }
          }

          if ($RETRY_COUNT -eq $MAX_RETRIES) {
            Write-Error "Failed to login after $MAX_RETRIES attempts."
            exit 1
          }

          # Parse secrets from JSON
          $secrets = ConvertFrom-Json $env:SECRETS_CONTEXT
          $secrets.PSObject.Properties | ForEach-Object {
            if ($_.Name -match '^TF_VAR_') {
              $lowerKey = $_.Name.ToLower()
              $finalKey = $lowerKey -replace '^tf_var_', 'TF_VAR_'
              [Environment]::SetEnvironmentVariable($finalKey, $_.Value, "Process")
            }
          }

          # Parse variables from JSON
          $variables = ConvertFrom-Json $env:VARS_CONTEXT
          $variables.PSObject.Properties | ForEach-Object {
            if ($_.Name -match '^TF_VAR_') {
              $lowerKey = $_.Name.ToLower()
              $finalKey = $lowerKey -replace '^tf_var_', 'TF_VAR_'
              [Environment]::SetEnvironmentVariable($finalKey, $_.Value, "Process")
            }
          }

          # Display custom environment variables
          Write-Host "Custom environment variables:"
          Get-ChildItem env: | Where-Object { $_.Name -match '^TF_VAR_' } | ForEach-Object {
            Write-Host "$($_.Name)=$($_.Value)"
          }

          # Set ARM environment variables
          $subscriptionInfo = az login --identity --username $env:MSI_ID | ConvertFrom-Json
          $env:ARM_SUBSCRIPTION_ID = $subscriptionInfo[0].id
          $env:ARM_TENANT_ID = $subscriptionInfo[0].tenantId

          $identityList = az identity list | ConvertFrom-Json
          $env:ARM_CLIENT_ID = ($identityList | Where-Object { $_.principalId -eq $env:MSI_ID }).clientId
          $env:ARM_USE_MSI = "true"

          # Run terraform test in Docker
          $currentPath = (Get-Location).Path
          docker run --rm `
            -v /var/run/docker.sock:/var/run/docker.sock `
            -v "${currentPath}:/src" `
            -w /src `
            --network=host `
            -e TF_IN_AUTOMATION `
            -e TF_VAR_enable_telemetry `
            -e AVM_MOD_PATH=/src `
            -e MSI_ID `
            -e ARM_SUBSCRIPTION_ID `
            -e ARM_TENANT_ID `
            -e ARM_CLIENT_ID `
            -e ARM_USE_MSI `
            mcr.microsoft.com/azterraform:latest make terraform-test
