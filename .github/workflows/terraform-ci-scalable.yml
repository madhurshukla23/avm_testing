name: Terraform CI - Scalable Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "modules/**/*.tf"
      - "modules/**/*.tfvars"
      - ".github/workflows/**"
      - ".github/modules-config.yml"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "modules/**/*.tf"
      - "modules/**/*.tfvars"
  workflow_dispatch:

env:
  TERRAFORM_VERSION: "1.9.0"

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  # ============================================
  # SETUP: Read module configuration
  # ============================================
  setup:
    name: Setup Module Matrix
    runs-on: [self-hosted, windows]
    outputs:
      modules: ${{ steps.set-matrix.outputs.modules }}
      examples: ${{ steps.set-matrix.outputs.examples }}
      modules-with-tests: ${{ steps.set-matrix.outputs.modules-with-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read modules configuration
        id: set-matrix
        run: |
          # Install yq for YAML parsing (Windows)
          if (-not (Test-Path "$env:TEMP\yq.exe")) {
            Invoke-WebRequest -Uri "https://github.com/mikefarah/yq/releases/latest/download/yq_windows_amd64.exe" -OutFile "$env:TEMP\yq.exe"
          }
          $env:PATH = "$env:TEMP;$env:PATH"

          # Extract enabled modules
          $MODULES = (& "$env:TEMP\yq.exe" eval '.modules[] | select(.enabled == true) | .name' .github/modules-config.yml) -split "`n" | Where-Object { $_ } | ConvertTo-Json -Compress
          "modules=$MODULES" >> $env:GITHUB_OUTPUT
          Write-Host "Modules to test: $MODULES"

          # Extract all module-example combinations
          $EXAMPLES = (& "$env:TEMP\yq.exe" eval -o=json '.modules[] | select(.enabled == true) | .examples[] as $ex | {"module": .name, "example": $ex}' .github/modules-config.yml | ConvertFrom-Json | ConvertTo-Json -Compress -AsArray)
          "examples=$EXAMPLES" >> $env:GITHUB_OUTPUT
          Write-Host "Examples to test: $EXAMPLES"

          # Extract modules with unit tests
          $MODULES_WITH_TESTS = (& "$env:TEMP\yq.exe" eval '.modules[] | select(.enabled == true and .has_unit_tests == true) | .name' .github/modules-config.yml) -split "`n" | Where-Object { $_ } | ConvertTo-Json -Compress
          "modules-with-tests=$MODULES_WITH_TESTS" >> $env:GITHUB_OUTPUT
          Write-Host "Modules with unit tests: $MODULES_WITH_TESTS"

  # ============================================
  # VALIDATE: All modules
  # ============================================
  validate:
    name: Validate
    needs: setup
    if: needs.setup.outputs.modules != '[]'
    strategy:
      matrix:
        module: ${{ fromJson(needs.setup.outputs.modules) }}
      fail-fast: false
    uses: ./.github/workflows/validate-module.yml
    with:
      module_name: ${{ matrix.module }}
      terraform_version: "1.9.0"
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # TEST EXAMPLES: All module examples
  # ============================================
  test-examples:
    name: Test Example
    needs: [setup, validate]
    if: needs.setup.outputs.examples != '[]'
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup.outputs.examples) }}
      fail-fast: false
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: ${{ matrix.module }}
      example_name: ${{ matrix.example }}
      terraform_version: "1.9.0"
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # LINT: All modules
  # ============================================
  lint:
    name: Lint
    needs: setup
    if: needs.setup.outputs.modules != '[]'
    strategy:
      matrix:
        module: ${{ fromJson(needs.setup.outputs.modules) }}
      fail-fast: false
    uses: ./.github/workflows/lint-module.yml
    with:
      module_name: ${{ matrix.module }}

  # ============================================
  # DOCS: All modules
  # ============================================
  docs:
    name: Documentation
    needs: setup
    if: needs.setup.outputs.modules != '[]'
    strategy:
      matrix:
        module: ${{ fromJson(needs.setup.outputs.modules) }}
      fail-fast: false
    uses: ./.github/workflows/generate-docs.yml
    with:
      module_name: ${{ matrix.module }}

  # ============================================
  # UNIT TESTS: Modules with tests
  # ============================================
  unit-tests:
    name: Unit Tests
    needs: setup
    if: needs.setup.outputs.modules-with-tests != '[]'
    strategy:
      matrix:
        module: ${{ fromJson(needs.setup.outputs.modules-with-tests) }}
      fail-fast: false
    uses: ./.github/workflows/unit-tests.yml
    with:
      module_name: ${{ matrix.module }}
      terraform_version: "1.9.0"

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: Pipeline Summary
    runs-on: [self-hosted, windows]
    needs: [setup, validate, test-examples, lint, docs, unit-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Summary
        run: |
          # Install yq for YAML parsing (Windows)
          if (-not (Test-Path "$env:TEMP\yq.exe")) {
            Invoke-WebRequest -Uri "https://github.com/mikefarah/yq/releases/latest/download/yq_windows_amd64.exe" -OutFile "$env:TEMP\yq.exe"
          }
          $env:PATH = "$env:TEMP;$env:PATH"

          "## ðŸš€ Terraform CI Pipeline Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY

          # Count modules
          $MODULE_COUNT = @((& "$env:TEMP\yq.exe" eval '.modules[] | select(.enabled == true) | .name' .github/modules-config.yml) -split "`n" | Where-Object { $_ }).Count
          $EXAMPLE_COUNT = @((& "$env:TEMP\yq.exe" eval '.modules[] | select(.enabled == true) | .examples[]' .github/modules-config.yml) -split "`n" | Where-Object { $_ }).Count
          $TEST_MODULE_COUNT = @((& "$env:TEMP\yq.exe" eval '.modules[] | select(.enabled == true and .has_unit_tests == true) | .name' .github/modules-config.yml) -split "`n" | Where-Object { $_ }).Count

          "### ðŸ“Š Coverage" >> $env:GITHUB_STEP_SUMMARY
          "- **Modules Tested:** $MODULE_COUNT" >> $env:GITHUB_STEP_SUMMARY
          "- **Examples Tested:** $EXAMPLE_COUNT" >> $env:GITHUB_STEP_SUMMARY
          "- **Modules with Unit Tests:** $TEST_MODULE_COUNT" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY

          "### ðŸ“¦ Module Validation" >> $env:GITHUB_STEP_SUMMARY
          if ("${{ needs.validate.result }}" -eq "success") {
            "âœ… All modules validated successfully" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ Module validation failed" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          "### ðŸ§ª Example Tests" >> $env:GITHUB_STEP_SUMMARY
          if ("${{ needs.test-examples.result }}" -eq "success") {
            "âœ… All $EXAMPLE_COUNT examples passed" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ Some examples failed" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          "### ðŸ” Code Quality (Linting)" >> $env:GITHUB_STEP_SUMMARY
          if ("${{ needs.lint.result }}" -eq "success") {
            "âœ… All modules passed linting" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ Linting failed for some modules" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          "### ðŸ“š Documentation" >> $env:GITHUB_STEP_SUMMARY
          if ("${{ needs.docs.result }}" -eq "success") {
            "âœ… Documentation generated for all modules" >> $env:GITHUB_STEP_SUMMARY
          } else {
            "âŒ Documentation generation failed" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          "### ðŸ§¬ Unit Tests" >> $env:GITHUB_STEP_SUMMARY
          if (("${{ needs.unit-tests.result }}" -eq "success") -or ("${{ needs.unit-tests.result }}" -eq "skipped")) {
            if ($TEST_MODULE_COUNT -gt 0) {
              "âœ… Unit tests passed for $TEST_MODULE_COUNT module(s)" >> $env:GITHUB_STEP_SUMMARY
            } else {
              "â„¹ï¸ No modules with unit tests" >> $env:GITHUB_STEP_SUMMARY
            }
          } else {
            "âŒ Unit tests failed" >> $env:GITHUB_STEP_SUMMARY
          }
          "" >> $env:GITHUB_STEP_SUMMARY

          "---" >> $env:GITHUB_STEP_SUMMARY
          "### ðŸŽ¯ Overall Status" >> $env:GITHUB_STEP_SUMMARY
          if (("${{ needs.validate.result }}" -eq "success") -and `
             ("${{ needs.test-examples.result }}" -eq "success") -and `
             ("${{ needs.lint.result }}" -eq "success") -and `
             ("${{ needs.docs.result }}" -eq "success") -and `
             (("${{ needs.unit-tests.result }}" -eq "success") -or ("${{ needs.unit-tests.result }}" -eq "skipped"))) {
            "### ðŸŽ‰ All checks passed!" >> $env:GITHUB_STEP_SUMMARY
            "" >> $env:GITHUB_STEP_SUMMARY
            "**Tested:** $MODULE_COUNT modules, $EXAMPLE_COUNT examples" >> $env:GITHUB_STEP_SUMMARY
            exit 0
          } else {
            "### âš ï¸ Some checks failed - please review above" >> $env:GITHUB_STEP_SUMMARY
            exit 1
          }
