name: Terraform CI - Main Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "modules/**/*.tf"
      - "modules/**/*.tfvars"
      - ".github/workflows/**"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "modules/**/*.tf"
      - "modules/**/*.tfvars"
  workflow_dispatch:

env:
  TERRAFORM_VERSION: "1.9.0"

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  # ============================================
  # MODULE VALIDATION
  # ============================================
  validate-storage:
    name: Validate Storage Account Module
    uses: ./.github/workflows/validate-module.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  validate-keyvault:
    name: Validate Key Vault Module
    uses: ./.github/workflows/validate-module.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # STORAGE ACCOUNT EXAMPLES
  # ============================================
  test-storage-default:
    name: Storage - Default
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: default
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-cmk:
    name: Storage - Customer Managed Key
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: customer-managed-key
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-datalake:
    name: Storage - Data Lake Gen2
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: data_lake_gen2
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-diagnostics:
    name: Storage - Diagnostic Settings
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: diagnostic-settings
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-localuser:
    name: Storage - Local User
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: local_user
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-mgmtpolicy:
    name: Storage - Management Policy
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: management-policy
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-pe-basic:
    name: Storage - Private Endpoint Basic
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: private-endpoint-basic
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-pe-managed:
    name: Storage - PE Manage DNS Zone
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: private-endpoint-manage_dns_zone_group
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-pe-static:
    name: Storage - PE Static IP
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: private-endpoint-static-ip
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-pe-unmanaged:
    name: Storage - PE Unmanage DNS Zone
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: private-endpoint-unmanage_dns_zone_group
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-storage-rbac:
    name: Storage - Role Assignments
    needs: validate-storage
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main
      example_name: role_assignments
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # KEY VAULT EXAMPLES
  # ============================================
  test-keyvault-default:
    name: Key Vault - Default
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: default
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-keyvault-accesspolicies:
    name: Key Vault - Access Policies
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: access-policies
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-keyvault-createkey:
    name: Key Vault - Create Key
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: create-key
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-keyvault-createsecret:
    name: Key Vault - Create Secret
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: create-secret
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-keyvault-diagnostics:
    name: Key Vault - Diagnostic Settings
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: diagnostic-settings
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  test-keyvault-pe:
    name: Key Vault - Private Endpoint
    needs: validate-keyvault
    uses: ./.github/workflows/test-example.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      example_name: private-endpoint
      terraform_version: ${{ env.TERRAFORM_VERSION }}
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ============================================
  # CODE QUALITY - LINTING
  # ============================================
  lint-storage:
    name: Lint Storage Account Module
    uses: ./.github/workflows/lint-module.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main

  lint-keyvault:
    name: Lint Key Vault Module
    uses: ./.github/workflows/lint-module.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main

  # ============================================
  # DOCUMENTATION
  # ============================================
  docs-storage:
    name: Docs for Storage Account
    uses: ./.github/workflows/generate-docs.yml
    with:
      module_name: terraform-azurerm-avm-res-storage-storageaccount-main

  docs-keyvault:
    name: Docs for Key Vault
    uses: ./.github/workflows/generate-docs.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests-keyvault:
    name: Unit Tests - Key Vault
    uses: ./.github/workflows/unit-tests.yml
    with:
      module_name: terraform-azurerm-avm-res-keyvault-vault-main
      terraform_version: ${{ env.TERRAFORM_VERSION }}

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs:
      - validate-storage
      - validate-keyvault
      - test-storage-default
      - test-storage-cmk
      - test-storage-datalake
      - test-storage-diagnostics
      - test-storage-localuser
      - test-storage-mgmtpolicy
      - test-storage-pe-basic
      - test-storage-pe-managed
      - test-storage-pe-static
      - test-storage-pe-unmanaged
      - test-storage-rbac
      - test-keyvault-default
      - test-keyvault-accesspolicies
      - test-keyvault-createkey
      - test-keyvault-createsecret
      - test-keyvault-diagnostics
      - test-keyvault-pe
      - lint-storage
      - lint-keyvault
      - docs-storage
      - docs-keyvault
      - unit-tests-keyvault
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Terraform CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ Module Validation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-storage.result }}" == "success" ]; then
            echo "âœ… Storage Account Module" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Storage Account Module" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.validate-keyvault.result }}" == "success" ]; then
            echo "âœ… Key Vault Module" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Key Vault Module" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ§ª Example Tests" >> $GITHUB_STEP_SUMMARY
          echo "Storage Account: 11 examples tested" >> $GITHUB_STEP_SUMMARY
          echo "Key Vault: 6 examples tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Code Quality" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint-storage.result }}" == "success" ] && [ "${{ needs.lint-keyvault.result }}" == "success" ]; then
            echo "âœ… All modules passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Some modules failed linting" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.docs-storage.result }}" == "success" ] && [ "${{ needs.docs-keyvault.result }}" == "success" ]; then
            echo "âœ… Documentation generated for all modules" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Documentation generation failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ§¬ Unit Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.unit-tests-keyvault.result }}" == "success" ]; then
            echo "âœ… Key Vault unit tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Key Vault unit tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Overall Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-storage.result }}" == "success" ] && \
             [ "${{ needs.validate-keyvault.result }}" == "success" ] && \
             [ "${{ needs.lint-storage.result }}" == "success" ] && \
             [ "${{ needs.lint-keyvault.result }}" == "success" ] && \
             [ "${{ needs.docs-storage.result }}" == "success" ] && \
             [ "${{ needs.docs-keyvault.result }}" == "success" ] && \
             [ "${{ needs.unit-tests-keyvault.result }}" == "success" ]; then
            echo "### ðŸŽ‰ All critical checks passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âš ï¸ Some checks failed - please review above" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
